"use strict";require("core-js/modules/es7.promise.finally"),require("core-js/modules/es6.promise"),require("core-js/modules/es6.regexp.replace"),require("core-js/modules/es6.regexp.match"),require("core-js/modules/es7.symbol.async-iterator"),require("core-js/modules/es6.symbol"),require("core-js/modules/es6.regexp.to-string"),require("core-js/modules/web.dom.iterable"),require("core-js/modules/es6.map");function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!(b&&c.length===b));d=!0);}catch(a){e=!0,f=a}finally{try{d||null==h["return"]||h["return"]()}finally{if(e)throw f}}return c}function _arrayWithHoles(a){if(Array.isArray(a))return a}var fs=require("fs"),path=require("path"),ScopeParser=require("./ScopeParser.js");module.exports=function(scope){var userTags=scope.userTags,ScopeApi={print:function e(a){for(var b,c=[],d=0;d<a.length;d+=1)a[d]instanceof Map||a[d]instanceof scope.arrayExpression().__proto__.constructor?c.push(a[d].toString()):c.push(a[d]);(b=console).log.apply(b,c)},createTag:function c(a,b){userTags[a.toLowerCase()]=b},getTag:function b(a){return userTags[a.toLowerCase()]},getAllTags:function a(){return userTags},debug:function b(a){a.forEach(function(a){ScopeApi.print([ScopeApi.__debugReturn(a)])})},__debugReturn:function __debugReturn(value){var spaces=1<arguments.length&&void 0!==arguments[1]?arguments[1]:2,result="",spacef=function(){for(var a="",b=0;b<spaces;b+=1)a+=" ";return a};if("object"==typeof value&&value instanceof Map){result+="Map(";var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=value[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var _step$value=_slicedToArray(_step.value,2),key=_step$value[0],val=_step$value[1];result+="\n".concat(spacef()).concat(key," => ").concat(ScopeApi.__debugReturn(val,spaces+2))}}catch(a){_didIteratorError=!0,_iteratorError=a}finally{try{_iteratorNormalCompletion||null==_iterator.return||_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return"".concat(result,")")}if("function"==typeof value){var source=value.toString(),args=source.match(/^\(args\=(\[.*\])\)/);return args=args[1]?eval(args[1]):[],result+="Scope([",args.forEach(function(a){result+="\n".concat(spacef(),"(").concat(typeof a.value,") ").concat(a.key,": ").concat(ScopeApi.__debugReturn(a.value,spaces+2))}),"".concat(result,"])")}return"string"==typeof value?"\"".concat(value,"\""):value},dereference:function d(a,b){var c;return void 0===b?b=a:c=a,c instanceof Map||c instanceof scope.arrayExpression().__proto__.constructor?c.delete(b):scope.dereferenceIdentifier(b)},if:function h(a){var b=_slicedToArray(a,3),c=b[0],d=b[1],e=void 0===d?function(){}:d,f=b[2],g=void 0===f?function(){}:f;return c?e():g()},each:function t(a){var b=_slicedToArray(a,2),c=b[0],d=b[1],e=void 0===d?function(){}:d,f=!1,g=function(){f=!0};if("numeric"===c.type){for(var h=[],j=0;j<c.size&&(h.push(e(c.get(j),j,g)),!f);j+=1);return scope.arrayExpression.apply(scope,h)}var k=scope.mapExpression(),l=!0,m=!1,n=void 0;try{for(var o,p=c[Symbol.iterator]();!(l=(o=p.next()).done);l=!0){var q=_slicedToArray(o.value,2),r=q[0],s=q[1];if(k.set(r,e(s,r,g)),f)break}}catch(a){m=!0,n=a}finally{try{l||null==p.return||p.return()}finally{if(m)throw n}}return k},toJS:function n(a){var b;if("object"!=typeof a||null===a)return a;if(a instanceof Map){b={};var c=!0,d=!1,e=void 0;try{for(var f,g=a[Symbol.iterator]();!(c=(f=g.next()).done);c=!0){var h=_slicedToArray(f.value,2),j=h[0],k=h[1];b[j]=ScopeApi.toJS(k)}}catch(a){d=!0,e=a}finally{try{c||null==g.return||g.return()}finally{if(d)throw e}}return b}if(a instanceof scope.arrayExpression().__proto__.constructor){for(var l=[],m=0;m<a.size;m+=1)l.push(ScopeApi.toJS(a[m]));return l}return null},toJSON:function b(a){return JSON.stringify(ScopeApi.toJS(a))},BSONtoMap:function c(a){var b;if("object"!=typeof a||Buffer.isBuffer(a)||"_bsontype"in a)return a;if(null===a)return!1;if(a instanceof Array){b=scope.arrayExpression();for(var d=0;d<a.length;d+=1)b[d]=ScopeApi.BSONtoMap(a[d]);return b}for(var e in b=scope.mapExpression(),a)Object.hasOwnProperty.call(a,e)&&(b[e]=ScopeApi.BSONtoMap(a[e]));return b},eval:function _eval(code){var parser=new ScopeParser,translation=parser.translate(code);return eval(translation.code)},compile:function e(a){var b=new ScopeParser,c=path.join(__scopedir,a),d=c.replace(/\.sc$/,".js");return new ScopeApi.promise(function(a,e){fs.readFile(c,"utf8",function(f,g){f&&e("Could not read file ".concat(c,".\n").concat(f));var h=b.translate(g,c,d);fs.writeFile(d,h.code,function(b){b&&e("Could not write to file ".concat(d,".\n").concat(b));var c=scope.import(d);a(c)})})})},promise:function d(a){var b=new Promise(function(b,c){a(b,c)}),c=scope.mapExpression();return c.set("then",function(a){b.then(function(b){a(b)})}),c.set("catch",function(a){b.catch(function(b){a(b)})}),c.set("finally",function(a){b.finally(function(){a()})}),c.originalPromise=b,c}};return ScopeApi.promise.get=function(a){return ScopeApi.promise[a]},ScopeApi.promise.all=function(a){var b=[],c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done);d=!0){var i=_slicedToArray(g.value,2),j=i[0],k=i[1],l=void 0;l=void 0===k.originalPromise?k:k.originalPromise,b.push(l),c.push(j)}}catch(a){e=!0,f=a}finally{try{d||null==h.return||h.return()}finally{if(e)throw f}}var m=Promise.all(b),n=scope.mapExpression();return n.set("then",function(a){m.then(function(b){for(var d=scope.mapExpression(),e=0;e<b.length;e+=1)d.set(c[e],b[e]);a(d)})}),n.set("catch",function(a){m.catch(function(b){a(b)})}),n.set("finally",function(a){m.finally(function(){a()})}),n},ScopeApi.print=scope.createScope(ScopeApi.print),ScopeApi.debug=scope.createScope(ScopeApi.debug),ScopeApi.if=scope.createScope(ScopeApi.if),ScopeApi.each=scope.createScope(ScopeApi.each),ScopeApi};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zY29wZVJ1bnRpbWVBcGkuanMiXSwibmFtZXMiOlsiZnMiLCJyZXF1aXJlIiwicGF0aCIsIlNjb3BlUGFyc2VyIiwibW9kdWxlIiwiZXhwb3J0cyIsInNjb3BlIiwidXNlclRhZ3MiLCJTY29wZUFwaSIsInZhbHVlIiwicmVzdWx0IiwiaSIsImxlbmd0aCIsIk1hcCIsImFycmF5RXhwcmVzc2lvbiIsIl9fcHJvdG9fXyIsImNvbnN0cnVjdG9yIiwicHVzaCIsInRvU3RyaW5nIiwiY29uc29sZSIsImxvZyIsImNyZWF0ZVRhZyIsIm5hbWUiLCJUIiwidG9Mb3dlckNhc2UiLCJnZXRUYWciLCJnZXRBbGxUYWdzIiwiZm9yRWFjaCIsInZhbCIsInByaW50IiwiX19kZWJ1Z1JldHVybiIsInNwYWNlcyIsInNwYWNlZiIsInIiLCJrZXkiLCJzb3VyY2UiLCJhcmdzIiwibWF0Y2giLCJldmFsIiwiYXJnIiwiaWRPck1hcCIsImlkIiwibWFwIiwiZGVsZXRlIiwiZGVyZWZlcmVuY2VJZGVudGlmaWVyIiwiY29uZGl0aW9uIiwiaWZUcnVlU2NvcGUiLCJpZkZhbHNlU2NvcGUiLCJhcnJheSIsImJsb2NrIiwiY2FuY2VsTG9vcCIsImNhbmNlbCIsInR5cGUiLCJzaXplIiwiZ2V0IiwibWFwRXhwcmVzc2lvbiIsInNldCIsInRvSlMiLCJpbnB1dCIsInRvSlNPTiIsIkpTT04iLCJzdHJpbmdpZnkiLCJCdWZmZXIiLCJpc0J1ZmZlciIsIkFycmF5IiwiQlNPTnRvTWFwIiwiT2JqZWN0IiwiaGFzT3duUHJvcGVydHkiLCJjYWxsIiwiY29kZSIsInBhcnNlciIsInRyYW5zbGF0aW9uIiwidHJhbnNsYXRlIiwiZmlsZW5hbWUiLCJzcmNGaWxlbmFtZSIsImpvaW4iLCJfX3Njb3BlZGlyIiwibGliRmlsZW5hbWUiLCJyZXBsYWNlIiwicHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJyZWFkRmlsZSIsImVyciIsInNyY0NvZGUiLCJ3cml0ZUZpbGUiLCJpbXAiLCJpbXBvcnQiLCJleGVjdXRvciIsInAiLCJQcm9taXNlIiwic1AiLCJzYyIsInRoZW4iLCJjYXRjaCIsImZpbmFsbHkiLCJvcmlnaW5hbFByb21pc2UiLCJhbGwiLCJtIiwiYXJyViIsImFycksiLCJ1bnBhY2tWYWwiLCJ2YWx1ZXMiLCJjcmVhdGVTY29wZSIsImRlYnVnIiwiaWYiLCJlYWNoIl0sIm1hcHBpbmdzIjoiNDZCQUFJQSxDQUFBQSxFQUFFLENBQUdDLE9BQU8sQ0FBQyxJQUFELEMsQ0FDWkMsSUFBSSxDQUFHRCxPQUFPLENBQUMsTUFBRCxDLENBQ2RFLFdBQVcsQ0FBR0YsT0FBTyxDQUFFLGtCQUFGLEMsQ0FFekJHLE1BQU0sQ0FBQ0MsT0FBUCxDQUFpQixTQUFDQyxLQUFELENBQVcsSUFDdEJDLENBQUFBLFFBQVEsQ0FBR0QsS0FBSyxDQUFDQyxRQURLLENBRXBCQyxRQUFRLENBQUcsQ0FDZixNQUFTLFdBQUFDLENBQUssQ0FBSSxDQUVoQixVQURJQyxDQUFNLENBQUcsRUFDYixDQUFTQyxDQUFDLENBQUcsQ0FBYixDQUFnQkEsQ0FBQyxDQUFHRixDQUFLLENBQUNHLE1BQTFCLENBQWtDRCxDQUFDLEVBQUksQ0FBdkMsQ0FDTUYsQ0FBSyxDQUFDRSxDQUFELENBQUwsVUFBb0JFLENBQUFBLEdBQXBCLEVBQTJCSixDQUFLLENBQUNFLENBQUQsQ0FBTCxVQUFvQkwsQ0FBQUEsS0FBSyxDQUFDUSxlQUFOLEdBQXdCQyxTQUF4QixDQUFrQ0MsV0FEdkYsQ0FFSU4sQ0FBTSxDQUFDTyxJQUFQLENBQVlSLENBQUssQ0FBQ0UsQ0FBRCxDQUFMLENBQVNPLFFBQVQsRUFBWixDQUZKLENBSUlSLENBQU0sQ0FBQ08sSUFBUCxDQUFZUixDQUFLLENBQUNFLENBQUQsQ0FBakIsQ0FKSixDQU9BLEdBQUFRLE9BQU8sRUFBQ0MsR0FBUixTQUFlVixDQUFmLENBQ0QsQ0FYYyxDQVlmVyxTQUFTLENBQUUsV0FBQ0MsQ0FBRCxDQUFPQyxDQUFQLENBQWEsQ0FDdEJoQixRQUFRLENBQUNlLENBQUksQ0FBQ0Us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a0IvRixRQUFRLENBQUNxQixLQUEzQixDQUlqQixDQUhBckIsUUFBUSxDQUFDZ0csS0FBVCxDQUFpQmxHLEtBQUssQ0FBQ2lHLFdBQU4sQ0FBa0IvRixRQUFRLENBQUNnRyxLQUEzQixDQUdqQixDQUZBaEcsUUFBUSxDQUFDaUcsRUFBVCxDQUFjbkcsS0FBSyxDQUFDaUcsV0FBTixDQUFrQi9GLFFBQVEsQ0FBQ2lHLEVBQTNCLENBRWQsQ0FEQWpHLFFBQVEsQ0FBQ2tHLElBQVQsQ0FBZ0JwRyxLQUFLLENBQUNpRyxXQUFOLENBQWtCL0YsUUFBUSxDQUFDa0csSUFBM0IsQ0FDaEIsQ0FBT2xHLFFBQ1IsQyIsInNvdXJjZXNDb250ZW50IjpbImxldCBmcyA9IHJlcXVpcmUoJ2ZzJyk7XG5sZXQgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmxldCBTY29wZVBhcnNlciA9IHJlcXVpcmUgKCcuL1Njb3BlUGFyc2VyLmpzJyk7XG5cbm1vZHVsZS5leHBvcnRzID0gKHNjb3BlKSA9PiB7XG4gIGxldCB1c2VyVGFncyA9IHNjb3BlLnVzZXJUYWdzO1xuICBjb25zdCBTY29wZUFwaSA9IHtcbiAgICBcInByaW50XCI6IHZhbHVlID0+IHtcbiAgICAgIGxldCByZXN1bHQgPSBbXTtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmFsdWUubGVuZ3RoOyBpICs9IDEpIHtcbiAgICAgICAgaWYgKHZhbHVlW2ldIGluc3RhbmNlb2YgTWFwIHx8IHZhbHVlW2ldIGluc3RhbmNlb2Ygc2NvcGUuYXJyYXlFeHByZXNzaW9uKCkuX19wcm90b19fLmNvbnN0cnVjdG9yKSB7XG4gICAgICAgICAgcmVzdWx0LnB1c2godmFsdWVbaV0udG9TdHJpbmcoKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzdWx0LnB1c2godmFsdWVbaV0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBjb25zb2xlLmxvZyguLi5yZXN1bHQpO1xuICAgIH0sXG4gICAgY3JlYXRlVGFnOiAobmFtZSwgVCkgPT4ge1xuICAgICAgdXNlclRhZ3NbbmFtZS50b0xvd2VyQ2FzZSgpXSA9IFQ7XG4gICAgfSxcbiAgICBnZXRUYWc6IG5hbWUgPT4ge1xuICAgICAgcmV0dXJuIHVzZXJUYWdzW25hbWUudG9Mb3dlckNhc2UoKV07XG4gICAgfSxcbiAgICBnZXRBbGxUYWdzOiAoKSA9PiB7XG4gICAgICByZXR1cm4gdXNlclRhZ3M7XG4gICAgfSxcbiAgICBcImRlYnVnXCI6IHZhbHVlID0+IHtcbiAgICB2YWx1ZS5mb3JFYWNoKCh2YWwpID0+IHtcbiAgICAgIFNjb3BlQXBpLnByaW50KFtTY29wZUFwaS5fX2RlYnVnUmV0dXJuKHZhbCldKTtcbiAgICB9KTtcbiAgICB9LFxuXG4gICAgXCJfX2RlYnVnUmV0dXJuXCI6ICh2YWx1ZSwgc3BhY2VzPTIpID0+IHtcbiAgICBsZXQgcmVzdWx0ID0gXCJcIjtcbiAgICBsZXQgc3BhY2VmID0gKCkgPT4ge1xuICAgICAgbGV0IHIgPSAnJztcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3BhY2VzOyBpICs9IDEpIHtcbiAgICAgIHIgKz0gJyAnO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHI7XG4gICAgfTtcbiAgICBpZiAodHlwZW9mIHZhbHVlID09PSBcIm9iamVjdFwiICYmIHZhbHVlIGluc3RhbmNlb2YgTWFwKSB7XG4gICAgICByZXN1bHQgKz0gXCJNYXAoXCI7XG4gICAgICBmb3IgKGxldCBba2V5LCB2YWxdIG9mIHZhbHVlKSB7XG4gICAgICByZXN1bHQgKz0gYFxcbiR7c3BhY2VmKCl9JHtrZXl9ID0+ICR7U2NvcGVBcGkuX19kZWJ1Z1JldHVybih2YWwsIHNwYWNlcyArIDIpfWBcbiAgICAgIH1cbiAgICAgIHJldHVybiBgJHtyZXN1bHR9KWA7XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgbGV0IHNvdXJjZSA9IHZhbHVlLnRvU3RyaW5nKCk7XG4gICAgICBsZXQgYXJncyA9IHNvdXJjZS5tYXRjaCgvXlxcKGFyZ3NcXD0oXFxbLipcXF0pXFwpLyk7XG4gICAgICBpZiAoYXJnc1sxXSkge1xuICAgICAgYXJncyA9IGV2YWwoYXJnc1sxXSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgYXJncyA9IFtdO1xuICAgICAgfVxuICAgICAgcmVzdWx0ICs9IFwiU2NvcGUoW1wiO1xuICAgICAgYXJncy5mb3JFYWNoKChhcmcpID0+IHtcbiAgICAgIHJlc3VsdCArPSBgXFxuJHtzcGFjZWYoKX0oJHt0eXBlb2YgYXJnLnZhbHVlfSkgJHthcmcua2V5fTogJHtTY29wZUFwaS5fX2RlYnVnUmV0dXJuKGFyZy52YWx1ZSwgc3BhY2VzICsgMil9YDtcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIGAke3Jlc3VsdH1dKWA7XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIHJldHVybiBgXCIke3ZhbHVlfVwiYDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cbiAgICB9LFxuXG4gICAgXCJkZXJlZmVyZW5jZVwiOiAoaWRPck1hcCwgaWQpID0+IHtcbiAgICAgIGxldCBtYXA7XG4gICAgICBpZiAoaWQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBpZCA9IGlkT3JNYXA7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBtYXAgPSBpZE9yTWFwO1xuICAgICAgfVxuXG4gICAgICBpZiAobWFwIGluc3RhbmNlb2YgTWFwIHx8IG1hcCBpbnN0YW5jZW9mIHNjb3BlLmFycmF5RXhwcmVzc2lvbigpLl9fcHJvdG9fXy5jb25zdHJ1Y3Rvcikge1xuICAgICAgICByZXR1cm4gbWFwLmRlbGV0ZShpZCk7XG4gICAgICB9XG4gICAgICByZXR1cm4gc2NvcGUuZGVyZWZlcmVuY2VJZGVudGlmaWVyKGlkKTtcbiAgICB9LFxuXG4gICAgXCJpZlwiOiAoW2NvbmRpdGlvbiwgaWZUcnVlU2NvcGUgPSAoKSA9PiB7fSwgaWZGYWxzZVNjb3BlID0gKCkgPT4ge31dKSA9PiB7XG4gICAgaWYgKGNvbmRpdGlvbikge1xuICAgICAgcmV0dXJuIGlmVHJ1ZVNjb3BlKCk7XG4gICAgfVxuICAgIHJldHVybiBpZkZhbHNlU2NvcGUoKTtcbiAgICB9LFxuXG4gICAgXCJlYWNoXCI6IChbYXJyYXksIGJsb2NrID0gKCkgPT4ge31dKSA9PiB7XG4gICAgICBsZXQgY2FuY2VsTG9vcCA9IGZhbHNlO1xuICAgICAgbGV0IGNhbmNlbCA9ICgpID0+IHtcbiAgICAgICAgY2FuY2VsTG9vcCA9IHRydWU7XG4gICAgICB9O1xuICAgICAgaWYgKGFycmF5LnR5cGUgPT09IFwibnVtZXJpY1wiKSB7XG4gICAgICAgIGxldCByZXN1bHQgPSBbXTtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnJheS5zaXplOyBpICs9IDEpIHtcbiAgICAgICAgICByZXN1bHQucHVzaChibG9jayhhcnJheS5nZXQoaSksIGksIGNhbmNlbCkpO1xuICAgICAgICAgIGlmIChjYW5jZWxMb29wKSB7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHNjb3BlLmFycmF5RXhwcmVzc2lvbiguLi5yZXN1bHQpO1xuICAgICAgfVxuICAgICAgbGV0IHJlc3VsdCA9IHNjb3BlLm1hcEV4cHJlc3Npb24oKTtcbiAgICAgIGZvciAobGV0IFtrZXksIHZhbF0gb2YgYXJyYXkpIHtcbiAgICAgICAgcmVzdWx0LnNldChrZXksIGJsb2NrKHZhbCwga2V5LCBjYW5jZWwpKTtcbiAgICAgICAgaWYgKGNhbmNlbExvb3ApIHtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9LFxuICAgIHRvSlM6IChpbnB1dCkgPT4ge1xuICAgICAgbGV0IHJlc3VsdDtcbiAgICAgIGlmICh0eXBlb2YgaW5wdXQgIT09IFwib2JqZWN0XCIgfHwgaW5wdXQgPT09IG51bGwpIHtcbiAgICAgICAgcmV0dXJuIGlucHV0O1xuICAgICAgfVxuICAgICAgaWYgKGlucHV0IGluc3RhbmNlb2YgTWFwKSB7XG4gICAgICAgIHJlc3VsdCA9IHt9O1xuICAgICAgICBmb3IgKGxldCBba2V5LCB2YWxdIG9mIGlucHV0KSB7XG4gICAgICAgICAgcmVzdWx0W2tleV0gPSBTY29wZUFwaS50b0pTKHZhbCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgIH1cbiAgICAgIGlmIChpbnB1dCBpbnN0YW5jZW9mIHNjb3BlLmFycmF5RXhwcmVzc2lvbigpLl9fcHJvdG9fXy5jb25zdHJ1Y3Rvcikge1xuICAgICAgICBsZXQgcmVzdWx0ID0gW107XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5wdXQuc2l6ZTsgaSArPSAxKSB7XG4gICAgICAgICAgcmVzdWx0LnB1c2goU2NvcGVBcGkudG9KUyhpbnB1dFtpXSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9LFxuICAgIHRvSlNPTjogKGlucHV0KSA9PiB7XG4gICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoU2NvcGVBcGkudG9KUyhpbnB1dCkpO1xuICAgIH0sXG4gICAgXCJCU09OdG9NYXBcIjogKGlucHV0KSA9PiB7XG4gICAgICBsZXQgcmVzdWx0O1xuICAgICAgaWYgKHR5cGVvZiBpbnB1dCAhPT0gXCJvYmplY3RcIiB8fCBCdWZmZXIuaXNCdWZmZXIoaW5wdXQpIHx8IChcIl9ic29udHlwZVwiIGluIGlucHV0KSkge1xuICAgICAgICByZXR1cm4gaW5wdXQ7XG4gICAgICB9XG4gICAgICBpZiAoaW5wdXQgPT09IG51bGwpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgaWYgKGlucHV0IGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgICAgcmVzdWx0ID0gc2NvcGUuYXJyYXlFeHByZXNzaW9uKCk7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5wdXQubGVuZ3RoOyBpICs9IDEpIHtcbiAgICAgICAgICByZXN1bHRbaV0gPSBTY29wZUFwaS5CU09OdG9NYXAoaW5wdXRbaV0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9XG4gICAgICByZXN1bHQgPSBzY29wZS5tYXBFeHByZXNzaW9uKCk7XG4gICAgICBmb3IgKGxldCBpIGluIGlucHV0KSB7XG4gICAgICAgIGlmIChPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChpbnB1dCwgaSkpIHtcbiAgICAgICAgICByZXN1bHRbaV0gPSBTY29wZUFwaS5CU09OdG9NYXAoaW5wdXRbaV0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0sXG4gICAgXCJldmFsXCI6IChjb2RlKSA9PiB7XG4gICAgICBsZXQgcGFyc2VyID0gbmV3IFNjb3BlUGFyc2VyKCk7XG4gICAgICBsZXQgdHJhbnNsYXRpb24gPSBwYXJzZXIudHJhbnNsYXRlKGNvZGUpO1xuICAgICAgcmV0dXJuIGV2YWwodHJhbnNsYXRpb24uY29kZSk7XG4gICAgfSxcbiAgICBcImNvbXBpbGVcIjogKGZpbGVuYW1lKSA9PiB7XG4gICAgICBsZXQgcGFyc2VyID0gbmV3IFNjb3BlUGFyc2VyKCk7XG4gICAgICBsZXQgc3JjRmlsZW5hbWUgPSBwYXRoLmpvaW4oX19zY29wZWRpciwgZmlsZW5hbWUpO1xuICAgICAgbGV0IGxpYkZpbGVuYW1lID0gc3JjRmlsZW5hbWUucmVwbGFjZSgvXFwuc2MkLywgXCIuanNcIik7XG4gICAgICByZXR1cm4gbmV3IFNjb3BlQXBpLnByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBmcy5yZWFkRmlsZShzcmNGaWxlbmFtZSwgXCJ1dGY4XCIsIChlcnIsIHNyY0NvZGUpID0+IHtcbiAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICByZWplY3QoYENvdWxkIG5vdCByZWFkIGZpbGUgJHtzcmNGaWxlbmFtZX0uXFxuJHtlcnJ9YCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGxldCB0cmFuc2xhdGlvbiA9IHBhcnNlci50cmFuc2xhdGUoc3JjQ29kZSwgc3JjRmlsZW5hbWUsIGxpYkZpbGVuYW1lKTtcbiAgICAgICAgICBmcy53cml0ZUZpbGUobGliRmlsZW5hbWUsIHRyYW5zbGF0aW9uLmNvZGUsIChlcnIpID0+IHtcbiAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgcmVqZWN0KGBDb3VsZCBub3Qgd3JpdGUgdG8gZmlsZSAke2xpYkZpbGVuYW1lfS5cXG4ke2Vycn1gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGxldCBpbXAgPSBzY29wZS5pbXBvcnQobGliRmlsZW5hbWUpO1xuICAgICAgICAgICAgcmVzb2x2ZShpbXApO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0sXG4gICAgXCJwcm9taXNlXCI6IGZ1bmN0aW9uIChleGVjdXRvcikge1xuICAgICAgbGV0IHAgPSBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIGV4ZWN1dG9yKHJlc29sdmUsIHJlamVjdCk7XG4gICAgICB9KTtcbiAgICAgIGxldCBzUCA9IHNjb3BlLm1hcEV4cHJlc3Npb24oKTtcblxuICAgICAgc1Auc2V0KFwidGhlblwiLCAoc2MpID0+IHtcbiAgICAgICAgcC50aGVuKChyZXN1bHQpID0+IHtcbiAgICAgICAgICBzYyhyZXN1bHQpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuXG4gICAgICBzUC5zZXQoXCJjYXRjaFwiLCAoc2MpID0+IHtcbiAgICAgICAgcC5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgc2MoZXJyKTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcblxuICAgICAgc1Auc2V0KFwiZmluYWxseVwiLCAoc2MpID0+IHtcbiAgICAgICAgcC5maW5hbGx5KCgpID0+IHtcbiAgICAgICAgICBzYygpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuXG4gICAgICBzUC5vcmlnaW5hbFByb21pc2UgPSBwO1xuXG4gICAgICByZXR1cm4gc1A7XG4gICAgfVxuICB9O1xuICBTY29wZUFwaS5wcm9taXNlLmdldCA9IChrZXkpID0+IHtcbiAgICByZXR1cm4gU2NvcGVBcGkucHJvbWlzZVtrZXldO1xuICB9O1xuICBTY29wZUFwaS5wcm9taXNlLmFsbCA9IChtKSA9PiB7XG4gICAgbGV0IGFyclYgPSBbXTtcbiAgICBsZXQgYXJySyA9IFtdO1xuICAgIGZvciAobGV0IFtrZXksIHZhbF0gb2YgbSkge1xuICAgICAgbGV0IHVucGFja1ZhbDtcbiAgICAgIGlmICh2YWwub3JpZ2luYWxQcm9taXNlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdW5wYWNrVmFsID0gdmFsLm9yaWdpbmFsUHJvbWlzZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHVucGFja1ZhbCA9IHZhbDtcbiAgICAgIH1cbiAgICAgIGFyclYucHVzaCh1bnBhY2tWYWwpO1xuICAgICAgYXJySy5wdXNoKGtleSk7XG4gICAgfVxuXG4gICAgbGV0IHAgPSBQcm9taXNlLmFsbChhcnJWKTtcbiAgICBsZXQgc1AgPSBzY29wZS5tYXBFeHByZXNzaW9uKCk7XG5cbiAgICBzUC5zZXQoXCJ0aGVuXCIsIChzYykgPT4ge1xuICAgICAgcC50aGVuKCh2YWx1ZXMpID0+IHtcbiAgICAgICAgbGV0IHJlc3VsdCA9IHNjb3BlLm1hcEV4cHJlc3Npb24oKTtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2YWx1ZXMubGVuZ3RoOyBpICs9IDEpIHtcbiAgICAgICAgICByZXN1bHQuc2V0KGFycktbaV0sIHZhbHVlc1tpXSk7XG4gICAgICAgIH1cbiAgICAgICAgc2MocmVzdWx0KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgc1Auc2V0KFwiY2F0Y2hcIiwgKHNjKSA9PiB7XG4gICAgICBwLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgc2MoZXJyKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgc1Auc2V0KFwiZmluYWxseVwiLCAoc2MpID0+IHtcbiAgICAgIHAuZmluYWxseSgoKSA9PiB7XG4gICAgICAgIHNjKCk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIHJldHVybiBzUDtcbiAgfTtcbiAgU2NvcGVBcGkucHJpbnQgPSBzY29wZS5jcmVhdGVTY29wZShTY29wZUFwaS5wcmludCk7XG4gIFNjb3BlQXBpLmRlYnVnID0gc2NvcGUuY3JlYXRlU2NvcGUoU2NvcGVBcGkuZGVidWcpO1xuICBTY29wZUFwaS5pZiA9IHNjb3BlLmNyZWF0ZVNjb3BlKFNjb3BlQXBpLmlmKTtcbiAgU2NvcGVBcGkuZWFjaCA9IHNjb3BlLmNyZWF0ZVNjb3BlKFNjb3BlQXBpLmVhY2gpO1xuICByZXR1cm4gU2NvcGVBcGk7XG59OyJdfQ==