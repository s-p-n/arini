<!doctype html>
<html>
<head>
	<title>Numeric-Map Implementation Benchmark</title>
</head>
<body>
	<h1>Numeric-Map Implementation Benchmark</h1>
	<div>
		Size: <input type="number" id="size" value="500000" />
		<br>
		<button id="get">Get</button>
		<button id="set">Set</button>
		<button id="delete">Delete</button>
		<button id="stop" disabled=true>Stop</button>
	</div>
	<div style="position:relative; height:500px">
		<canvas id="chart" width="1000" height="500"></canvas>
	</div>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.min.js"></script>
	<script>
		let ctx = document.getElementById("chart").getContext("2d");
		let mapData = [];
		let arrayData = [];
		let myChart = new Chart(ctx, {
		    type: 'line',
		    data: {
		    	labels: [],
		        datasets: [
		        	{
		        		label: "array",
		        		borderColor: "#0000FF",
		        		backgroundColor: "rgba(0, 0, 255, 0.4)",
		        		data: arrayData
		        	}, 
				{
		        		label: "map",
		        		borderColor: "#00FF00",
		        		backgroundColor: "rgba(0, 255, 0, 0.4)",
		        		data: mapData
		        	}
		        ]
		    },
		    options: {
		    	responsive: false
		    }
		});
		class Benchmark {
			constructor () {
				this.benchmarks = {};
			}

			start (name) {
				this.benchmarks[name] = {
					name: name,
					start: Date.now(),
					end: NaN,
					difference: NaN
				}
			}

			end (name) {
				this.benchmarks[name].end = Date.now();
				this.benchmarks[name].difference = this.benchmarks[name].end - this.benchmarks[name].start;
			}

			report (name) {
				if (name) {
					return this.benchmarks[name];
				}
				return this.benchmarks;
			}
		}
		let mapSize = 500000;
		let b = new Benchmark();
		let m = new Map();
		let fm = [];
		function initMap () {
			let arr = new Array(mapSize);
			for (let i = 0; i < mapSize; i += 1) {
				arr[i] = [i, i + 1];
			}
			fm = arr;
			fm.get = (id) => {
				return fm[id][1];
			};
			fm.set = (id, val) => {
				fm[id] = [id, val];
				return val;
			};
			fm.delete = (id) => {
				if (fm.indexOf(id) !== -1) {
					fm.splice(id, 1);
					return true;
				}
				return false;
			};
			m = new Map(arr);
		}

		function mapDeletion (id) {
			let map = m;
			if (map.delete(id)) {
				if (id === map.size) {
					//console.log("fast delete");
					return true;
				}
				//console.log("renumber map");
				let i = 0;
				let stop = map.size + 0;
				for (let i = id; i < stop; i += 1) {
					//console.log(map);
					let val = map.get(i + 1);
					map.delete(i + 1);
					map.set(i, val);
				}
				return true;
			} else {
				return false;
			}
		}
		
		function fmDeletion (id) {
			fm.delete(id);
		}
		
		let stop = true;
		function postStop () {
			mapData.length = 0;
			arrayData.length = 0;
			sizeInput.disabled = false;
			getBtn.disabled = false;
			setBtn.disabled = false;
			deleteBtn.disabled = false;
			stopBtn.disabled = true;
		}
		function postStart () {
			sizeInput.disabled = true;
			getBtn.disabled = true;
			setBtn.disabled = true;
			deleteBtn.disabled = true;
			stopBtn.disabled = false;
			myChart.data.labels.length = 0;
			stop = false;
		}
		function runDelete () {
			let step = 10000;
			let innerStep = 0;
			function intervalFunc(id) {
				if (id >= mapSize || stop) {
					postStop();
					return;
				}
				switch (innerStep) {
					case 0:
						b.start('map');
						mapDeletion(id);
						b.end('map');
						break;
					case 1:
						b.start('array');
						fmDeletion(id);
						b.end('array');
						break;
					default:
						let result = b.report();
						mapData.push({x: id, y: result.map.difference});
						arrayData.push({x: id, y: result.array.difference});
						myChart.data.labels.push(id);
						myChart.update({duration: 0});
						initMap();
						id += step;
				}
				innerStep += 1;
				if (innerStep > 2) {
					innerStep = 0;
				}
				//console.log("updated:", newData, iterData);
				window.requestAnimationFrame(() => {
					intervalFunc(id);
				});
			};
			postStart();
			initMap();
			window.requestAnimationFrame(() => {
				intervalFunc(0);
			});
		}

		function runGet () {
			let step = 10000;
			let innerStep = 0;
			function intervalFunc (id) {
				if (id >= mapSize || stop) {
					postStop();
					return;
				}
				switch(innerStep) {
					case 0:
						b.start('map');
						for (let i = id; i < id + step; i += 1) {
							m.get(i);
						}
						b.end('map');
						break;
					case 1:
						b.start('array');
						for (let i = id; i < id + step; i += 1) {
							fm.get(i);
						}
						b.end('array');
						break;
					default:
						let result = b.report();
						mapData.push({x: id, y: result.map.difference});
						arrayData.push({x: id, y: result.array.difference});
						myChart.data.labels.push(id);
						myChart.update({duration: 0});
						initMap();
						id += step;
				}
				innerStep += 1;
				if (innerStep > 2) {
					innerStep = 0;
				}
				//console.log("updated:", newData, iterData);
				window.requestAnimationFrame(() => {
					intervalFunc(id);
				});
			}
			postStart();
			initMap();
			window.requestAnimationFrame(() => {
				intervalFunc(0);
			});
		}

		function runSet () {
			let step = 10000;
			let innerStep = 0;
			function intervalFunc (id) {
				if (id >= mapSize || stop) {
					postStop();
					return;
				}
				switch(innerStep) {
					case 0:
						b.start('map');
						for (let i = id; i < id + step; i += 1) {
							m.set(i, "a");
						}
						b.end('map');
						break;
					case 1:
						b.start('array');
						for (let i = id; i < id + step; i += 1) {
							fm.set(i, "a");
						}
						b.end('array');
						break;
					default:
						let result = b.report();
						mapData.push({x: id, y: result.map.difference});
						arrayData.push({x: id, y: result.array.difference});
						myChart.data.labels.push(id);
						myChart.update({duration: 0});
						initMap();
						id += step;
				}
				innerStep += 1;
				if (innerStep > 2) {
					innerStep = 0;
				}
				//console.log("updated:", newData, iterData);
				window.requestAnimationFrame(() => {
					intervalFunc(id);
				});
			}
			postStart();
			initMap();
			window.requestAnimationFrame(() => {
				intervalFunc(0);
			});
		}

		let sizeInput = document.getElementById('size');
		let getBtn = document.getElementById('get');
		let setBtn = document.getElementById('set');
		let deleteBtn = document.getElementById('delete');
		let stopBtn = document.getElementById('stop');

		stopBtn.addEventListener('click', () => {
			stop = true;
		});

		sizeInput.addEventListener('keyup', function (e) {
			mapSize = parseInt(this.value);
		});
		getBtn.addEventListener('click', runGet);
		setBtn.addEventListener('click', runSet);
		deleteBtn.addEventListener('click', runDelete);


	</script>
</body>
</html>
